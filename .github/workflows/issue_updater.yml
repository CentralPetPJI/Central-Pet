name: Reescrever Issue com IA (formato padrão)

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read

jobs:
  format-issue:
    # Só executa quando a label triage-pendente é adicionada e ainda não foi formatada
    if: |
      github.event.label.name == 'triagem-pendente' &&
      !contains(github.event.issue.labels.*.name, 'formatado-por-ia')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Reescrever descrição com IA
        id: ai-rewrite
        uses: actions/ai-inference@v1
        with:
          model: openai/gpt-4o-mini
          # alternativas:
          # model: anthropic/claude-3.5-sonnet
          # model: google/gemini-1.5-flash
          system-prompt: |
            Você é um assistente que padroniza issues no GitHub.
            Sua tarefa é REESCREVER completamente a issue mantendo o significado original,
            mas transformando em um formato de tarefa profissional e claro.

            Regras obrigatórias:
            - Título: deve ser reescrito para ficar curto, objetivo e começar com [Tipo]:
              Tipos válidos: [Bug], [Feature], [Refactor], [Chore], [Doc], [Test]

            - Descrição deve seguir ESTE template exato:

            ## Descrição
            (explicação clara do que precisa ser feito)

            ## Motivação / Contexto
            (por que isso é importante / qual problema resolve)

            ## Comportamento Esperado
            (o que deveria acontecer)

            ## Comportamento Atual (se for bug)
            (o que está acontecendo hoje)

            ## Passos para Reproduzir (se aplicável)
            1.
            2.

            ## Critérios de Aceitação
            - [ ] Critério 1
            - [ ] Critério 2

            Regras adicionais obrigatórias:
            - Preserve integralmente (sem alterar) qualquer trecho do corpo original que contenha:
              - imagens em Markdown no formato ![...](...)
              - links para anexos (ex.: user-images.githubusercontent.com, github.com/user-attachments, user-attachments/assets)
            
            - Use linguagem objetiva, direta e em português
            - Remova emojis desnecessários, gírias excessivas e texto informal
            - Mantenha todos os detalhes técnicos importantes
            - Se faltar informação crítica, adicione uma seção ## Informações Faltantes

          prompt: |
            Título original: ${{ github.event.issue.title }}

            Corpo original:
            ${{ github.event.issue.body }}

            Responda APENAS com o texto final em Markdown.
            A primeira linha deve ser o título.
            Não use blocos ```markdown nem texto extra.

      - name: Atualizar issue com texto reescrito (preservando anexos)
        if: steps.ai-rewrite.outputs.response != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ORIGINAL_BODY: ${{ github.event.issue.body }}
          RESPONSE_FILE: ${{ steps.ai-rewrite.outputs.response-file }}
        run: |
          set -euo pipefail
      
          # Lê resposta da IA do arquivo (mais seguro para multiline/outputs grandes)
          NEW_BODY="$(cat "$RESPONSE_FILE")"
      
          # Extrai anexos do corpo original (imagens markdown e links comuns de anexos)
          ATTACHMENTS="$(printf "%s\n" "$ORIGINAL_BODY" | \
            grep -E '!\[[^]]*\]\([^)]+\)|https?://(user-images\.githubusercontent\.com|github\.com/user-attachments|.*user-attachments.*)' \
            || true)"
      
          # Extrai título e corpo da resposta da IA
          TITLE="$(printf "%s" "$NEW_BODY" | sed -n '1p')"
          BODY="$(printf "%s" "$NEW_BODY" | sed '1d')"
      
          # Se o corpo novo NÃO contém os anexos originais, reanexa no final
          if [ -n "${ATTACHMENTS:-}" ]; then
            MISSING=false
            while IFS= read -r line; do
              [ -z "$line" ] && continue
              if ! printf "%s\n" "$BODY" | grep -Fq "$line"; then
                MISSING=true
                break
              fi
            done <<< "$ATTACHMENTS"
      
            if [ "$MISSING" = true ]; then
              if ! printf "%s\n" "$BODY" | grep -qiE '^\s*##\s+Anexos\s*$'; then
                BODY="$(printf "%s\n\n## Anexos\n%s\n" "$BODY" "$ATTACHMENTS")"
              else
                BODY="$(printf "%s\n\n%s\n" "$BODY" "$ATTACHMENTS")"
              fi
            fi
          fi
      
          # Atualiza issue
          gh issue edit "$ISSUE_NUMBER" --title "$TITLE" --body "$BODY"
      
          # Labels
          gh issue edit "$ISSUE_NUMBER" --add-label "formatado-por-ia" || true
          gh issue edit "$ISSUE_NUMBER" --remove-label "triagem-pendente" || true
  
      # Comentário automático
      gh issue comment "$ISSUE_NUMBER" --body "Issue formatada automaticamente por IA no padrão da equipe."          gh issue comment "$ISSUE_NUMBER" --body "Issue formatada automaticamente por IA no padrão da equipe."
